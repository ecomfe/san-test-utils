<!doctype html><html><head><meta charset="utf-8"/><title>san-test-utils</title><link rel="icon" href="https://baidu.github.io/san/img/favicon.ico"><script>window['SAN_DOCIT'] = {};</script><base href="/san-test-utils/"><meta name="description" content="单元测试实用工具库"><link href="/san-test-utils/static/css/chunk-vendors.css" rel="stylesheet"></head><body><div id="app"><div id="site"><header id="header"><a href="/san-test-utils/" class="navbar"><img src="/san-test-utils/logo.svg" alt="Home" class="logo"> <span>san-test-utils</span></a><ul></ul></header><aside id="sidebar" class="sidebar"><ul class="tree"><li><span>介绍</span><ul><li data-id="/"><a href="/san-test-utils/" onclick="return false;">介绍</a></li></ul></li><li><span>教程</span><ul><li data-id="/guides/start/"><a href="/san-test-utils/guides/start/" onclick="return false;">起步</a></li><li data-id="/guides/common-tips/"><a href="/san-test-utils/guides/common-tips/" onclick="return false;">常用技巧</a></li><li data-id="/guides/event/"><a href="/san-test-utils/guides/event/" onclick="return false;">测试键盘、鼠标等其它 DOM 事件</a></li><li data-id="/guides/test-runner/"><a href="/san-test-utils/guides/test-runner/" onclick="return false;">选择一个测试运行器</a></li><li data-id="/guides/jest-demo/"><a href="/san-test-utils/guides/jest-demo/" onclick="return false;">用 Jest 测试组件</a></li><li data-id="/guides/mocha-demo/"><a href="/san-test-utils/guides/mocha-demo/" onclick="return false;">用 Mocha 和 webpack 测试组件</a></li><li data-id="/guides/karma-demo/"><a href="/san-test-utils/guides/karma-demo/" onclick="return false;">用 Karma 测试组件</a></li><li data-id="/guides/async/"><a href="/san-test-utils/guides/async/" onclick="return false;">测试异步行为</a></li></ul></li><li><span>API</span><ul><li data-id="/api/attach/"><a href="/san-test-utils/api/attach/" onclick="return false;">attach</a></li><li data-id="/api/shallowAttach/"><a href="/san-test-utils/api/shallowAttach/" onclick="return false;">shallowAttach</a></li><li data-id="/api/render/"><a href="/san-test-utils/api/render/" onclick="return false;">render</a></li><li data-id="/api/renderToString/"><a href="/san-test-utils/api/renderToString/" onclick="return false;">renderToString</a></li><li data-id="/api/selector/"><a href="/san-test-utils/api/selector/" onclick="return false;">选择器</a></li><li data-id="/api/createWrapper/"><a href="/san-test-utils/api/createWrapper/" onclick="return false;">createWrapper</a></li><li data-id="/api/config/"><a href="/san-test-utils/api/config/" onclick="return false;">配置</a></li></ul></li><li><span>Wrapper</span><ul><li data-id="/wrapper/index/"><a href="/san-test-utils/wrapper/index/" onclick="return false;">属性</a></li><li data-id="/wrapper/attributes/"><a href="/san-test-utils/wrapper/attributes/" onclick="return false;">attributes</a></li><li data-id="/wrapper/classes/"><a href="/san-test-utils/wrapper/classes/" onclick="return false;">classes</a></li><li data-id="/wrapper/contains/"><a href="/san-test-utils/wrapper/contains/" onclick="return false;">contains</a></li><li data-id="/wrapper/fired/"><a href="/san-test-utils/wrapper/fired/" onclick="return false;">fired</a></li><li data-id="/wrapper/firedByOrder/"><a href="/san-test-utils/wrapper/firedByOrder/" onclick="return false;">firedByOrder</a></li><li data-id="/wrapper/data/"><a href="/san-test-utils/wrapper/data/" onclick="return false;">data</a></li><li data-id="/wrapper/detach/"><a href="/san-test-utils/wrapper/detach/" onclick="return false;">detach</a></li><li data-id="/wrapper/dispatched/"><a href="/san-test-utils/wrapper/dispatched/" onclick="return false;">dispatched</a></li><li data-id="/wrapper/dispatchedByOrder/"><a href="/san-test-utils/wrapper/dispatchedByOrder/" onclick="return false;">dispatchedByOrder</a></li><li data-id="/wrapper/exists/"><a href="/san-test-utils/wrapper/exists/" onclick="return false;">exists</a></li><li data-id="/wrapper/find/"><a href="/san-test-utils/wrapper/find/" onclick="return false;">find</a></li><li data-id="/wrapper/findAll/"><a href="/san-test-utils/wrapper/findAll/" onclick="return false;">findAll</a></li><li data-id="/wrapper/html/"><a href="/san-test-utils/wrapper/html/" onclick="return false;">html</a></li><li data-id="/wrapper/is/"><a href="/san-test-utils/wrapper/is/" onclick="return false;">is</a></li><li data-id="/wrapper/isEmpty/"><a href="/san-test-utils/wrapper/isEmpty/" onclick="return false;">isEmpty</a></li><li data-id="/wrapper/isVisible/"><a href="/san-test-utils/wrapper/isVisible/" onclick="return false;">isVisible</a></li><li data-id="/wrapper/isSanInstance/"><a href="/san-test-utils/wrapper/isSanInstance/" onclick="return false;">isSanInstance</a></li><li data-id="/wrapper/setChecked/"><a href="/san-test-utils/wrapper/setChecked/" onclick="return false;">setChecked</a></li><li data-id="/wrapper/setData/"><a href="/san-test-utils/wrapper/setData/" onclick="return false;">setData</a></li><li data-id="/wrapper/setMethods/"><a href="/san-test-utils/wrapper/setMethods/" onclick="return false;">setMethods</a></li><li data-id="/wrapper/setSelected/"><a href="/san-test-utils/wrapper/setSelected/" onclick="return false;">setSelected</a></li><li data-id="/wrapper/setValue/"><a href="/san-test-utils/wrapper/setValue/" onclick="return false;">setValue</a></li><li data-id="/wrapper/text/"><a href="/san-test-utils/wrapper/text/" onclick="return false;">text</a></li><li data-id="/wrapper/trigger/"><a href="/san-test-utils/wrapper/trigger/" onclick="return false;">trigger</a></li></ul></li><li><span>WrapperArray</span><ul><li data-id="/wrapperArray/index/"><a href="/san-test-utils/wrapperArray/index/" onclick="return false;">属性</a></li><li data-id="/wrapperArray/at/"><a href="/san-test-utils/wrapperArray/at/" onclick="return false;">at</a></li><li data-id="/wrapperArray/detach/"><a href="/san-test-utils/wrapperArray/detach/" onclick="return false;">detach</a></li><li data-id="/wrapperArray/filter/"><a href="/san-test-utils/wrapperArray/filter/" onclick="return false;">filter</a></li><li data-id="/wrapperArray/is/"><a href="/san-test-utils/wrapperArray/is/" onclick="return false;">is</a></li><li data-id="/wrapperArray/isEmpty/"><a href="/san-test-utils/wrapperArray/isEmpty/" onclick="return false;">isEmpty</a></li><li data-id="/wrapperArray/isSanInstance/"><a href="/san-test-utils/wrapperArray/isSanInstance/" onclick="return false;">isSanInstance</a></li><li data-id="/wrapperArray/setChecked/"><a href="/san-test-utils/wrapperArray/setChecked/" onclick="return false;">setChecked</a></li><li data-id="/wrapperArray/setData/"><a href="/san-test-utils/wrapperArray/setData/" onclick="return false;">setData</a></li><li data-id="/wrapperArray/setMethods/"><a href="/san-test-utils/wrapperArray/setMethods/" onclick="return false;">setMethods</a></li><li data-id="/wrapperArray/setValue/"><a href="/san-test-utils/wrapperArray/setValue/" onclick="return false;">setValue</a></li><li data-id="/wrapperArray/trigger/"><a href="/san-test-utils/wrapperArray/trigger/" onclick="return false;">trigger</a></li></ul></li><li><span>挂载选项</span><ul><li data-id="/attachOptions/slots/"><a href="/san-test-utils/attachOptions/slots/" onclick="return false;">slots</a></li><li data-id="/attachOptions/stubs/"><a href="/san-test-utils/attachOptions/stubs/" onclick="return false;">stubs</a></li><li data-id="/attachOptions/data/"><a href="/san-test-utils/attachOptions/data/" onclick="return false;">data</a></li><li data-id="/attachOptions/attachToDocument/"><a href="/san-test-utils/attachOptions/attachToDocument/" onclick="return false;">attachToDocument</a></li><li data-id="/attachOptions/parentComponent/"><a href="/san-test-utils/attachOptions/parentComponent/" onclick="return false;">parentComponent</a></li><li data-id="/attachOptions/methods/"><a href="/san-test-utils/attachOptions/methods/" onclick="return false;">methods</a></li></ul></li></ul></aside><article id="content"><div id="router-view" class="router-view"><div class="content markdown-content"><div class="markdown"><h1 id="%E7%94%A8-mocha-%E5%92%8C-webpack-%E6%B5%8B%E8%AF%95%E7%BB%84%E4%BB%B6">用 Mocha 和 webpack 测试组件</h1><blockquote><p>我们在 <a href="https://github.com/ecomfe/san-test-utils/tree/master/docs/demo/mocha" target="_blank">github</a> 上放有一个关于这些设置的示例工程。</p></blockquote><p>另一个测试单文件组件的策略是通过 webpack 编译所有的测试文件然后在测试运行器中运行。这样做的好处是可以完全支持所有 webpack 和 san-loader 的功能，所以我们不必对我们的源代码做任何妥协。</p><p>从技术的角度讲，你可以使用任何喜欢的测试运行器并把所有的东西都手动串联起来，但是我们已经找到了 <code>mocha-webpack</code> 能够为这项特殊任务提供非常流畅的体验。</p><h3 id="%E8%AE%BE%E7%BD%AE-mocha-webpack">设置 mocha-webpack</h3><p>我们假定你在一开始已经安装并配置好了 webpack、san-loader 和 Babel。</p><p>首先要做的是安装测试依赖：</p><pre class="language-js"><code class="language-js">$ npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev san<span class="token operator">-</span>test<span class="token operator">-</span>utils mocha mocha<span class="token operator">-</span>webpack</code></pre><p>接下来我们需要在 <code>package.json</code> 中定义一个测试脚本。</p><pre class="language-js"><code class="language-js"><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
    <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mocha-webpack --webpack-config webpack.config.js --require test/setup.js test/**/*.spec.js&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>这里有一些注意事项：</p><ul><li><p><code>--webpack-config</code> 标识指定了该测试使用的 webpack 配置文件。在大多数情况下该配置会在其实际项目的配置文件基础上做一些小的调整。</p></li><li><p><code>--require</code> 标识确保了文件 <code>test/setup.js</code> 会在任何测试之前运行，这样我们可以在该文件中设置测试所需的全局环境。</p></li><li><p>最后一个参数是该测试包所涵盖的所有测试文件的聚合。</p></li></ul><h3 id="%E6%8F%90%E5%8F%96-webpack-%E9%85%8D%E7%BD%AE">提取 webpack 配置</h3><h4 id="%E6%9A%B4%E9%9C%B2-npm-%E4%BE%9D%E8%B5%96">暴露 NPM 依赖</h4><p>在测试中我们很可能会导入一些 NPM 依赖——这里面的有些模块可能没有针对浏览器的场景编写，也不适合被 webpack 打包。另一个考虑是为了尽可能的将依赖外置以提升测试的启动速度。我们可以通过 <code>webpack-node-externals</code> 外置所有的 NPM 依赖：</p><pre class="language-js"><code class="language-js"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-node-externals&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token literal-property property">externals</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre><h4 id="%E6%BA%90%E7%A0%81%E8%A1%A8">源码表</h4><p>源码表在 <code>mocha-webpack</code> 中需要通过内联的方式获取。推荐配置为：</p><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">&#39;inline-cheap-module-source-map&#39;</span>
<span class="token punctuation">}</span></code></pre><p>如果是在 IDE 中调试，我们推荐添加以下配置：</p><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 在源码表中使用绝对路径 (对于在 IDE 中调试时很重要)</span>
        <span class="token literal-property property">devtoolModuleFilenameTemplate</span><span class="token operator">:</span> <span class="token string">&#39;[absolute-resource-path]&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">devtoolFallbackModuleFilenameTemplate</span><span class="token operator">:</span> <span class="token string">&#39;[absolute-resource-path]?[hash]&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><h3 id="%E8%AE%BE%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%E7%8E%AF%E5%A2%83">设置浏览器环境</h3><p>San Test Utils 需要在浏览器环境中运行。我们可以在 Node 中使用 <code>jsdom-global</code> 进行模拟：</p><pre class="language-js"><code class="language-js">$ npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev jsdom jsdom<span class="token operator">-</span>global</code></pre><p>然后在 <code>test/setup.js</code> 中写入：</p><pre class="language-js"><code class="language-js"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;jsdom-global&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这行代码会在 Node 中添加一个浏览器环境，这样 San Test Utils 就可以正确运行了。</p><h3 id="%E9%80%89%E7%94%A8%E4%B8%80%E4%B8%AA%E6%96%AD%E8%A8%80%E5%BA%93">选用一个断言库</h3><p><a href="http://chaijs.com/" target="_blank">Chai</a> 是一个流行的断言库，经常和 Mocha 配合使用。你可能也想把 <a href="http://sinonjs.org/" target="_blank">Sinon</a> 用于创建间谍和存根。</p><p>另外你也可以使用 <code>expect</code>，它现在是 Jest 的一部分，且在 Jest 文档里暴露了<a href="https://jestjs.io/docs/zh-Hans/expect" target="_blank">完全相同的 API</a>。</p><p>这里我们将使用 <code>expect</code> 且令其全局可用，这样我们就不需要在每个测试文件里导入它了：</p><pre class="language-js"><code class="language-js">$ npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev expect</code></pre><p>然后在 <code>test/setup.js</code> 中编写：</p><pre class="language-js"><code class="language-js"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;jsdom-global&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

global<span class="token punctuation">.</span>expect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;expect&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="%E4%B8%BA%E6%B5%8B%E8%AF%95%E4%BC%98%E5%8C%96-babel">为测试优化 Babel</h3><p>注意我们使用了 babel-loader 来处理 JavaScript。如果你在你的应用中通过 <code>.babelrc</code> 文件使用了 Babel，那么你就已经算是把它配置好了。这里 <code>babel-loader</code> 将会自动使用相同的配置文件。</p><p>有一件事值得注意，如果你使用了 Node 6+，它已经支持了主要的 ES2015 特性，那么你可以配置一个独立的 Babel <a href="https://babeljs.io/docs/usage/babelrc/#env-option" target="_blank">环境选项</a>，只转译该 Node 版本中不支持的特性 (比如 <code>stage-2</code> 或 flow 语法支持等)。</p><h3 id="%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95">添加一个测试</h3><p>在 <code>src</code> 目录中创建一个名为 list.san 的文件：</p><pre class="language-js"><code class="language-js"><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>li s<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;item in items&quot;</span><span class="token operator">&gt;</span>
            <span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></code></pre><p>然后创建一个名为 test/list.test.js 的测试文件并写入如下代码：</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>shallowAttach<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;san-test-utils&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> list <span class="token keyword">from</span> <span class="token string">&#39;../src/list.san&#39;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;list&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;renders li for each item in items&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowAttach</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>items<span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveLength</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>现在我们运行测试：</p><pre class="language-js"><code class="language-js">$ npm run test</code></pre><p>喔，我们的测试运行起来了！</p><h3 id="%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%E7%8E%87">测试覆盖率</h3><p>如果想设置 <code>mocha-webpack</code> 的测试覆盖率，请参照 <code>mocha-webpack</code> 测试覆盖率指南。</p><h3 id="%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99">相关资料</h3><ul><li><a href="https://github.com/ecomfe/san-test-utils/tree/master/docs/demo/mocha" target="_blank">该设置的示例工程</a></li><li><a href="https://mochajs.org/" target="_blank">Mocha</a></li><li><a href="http://zinserjan.github.io/mocha-webpack/" target="_blank">mocha-webpack</a></li><li><a href="http://chaijs.com/" target="_blank">Chai</a></li><li><a href="http://sinonjs.org/" target="_blank">Sinona</a></li><li><a href="https://jestjs.io/docs/zh-Hans/expect" target="_blank">jest/expect</a></li></ul></div></div></div><aside class="toc"><ul class="tree"></ul></aside></article></div></div><script src="/san-test-utils/static/js/chunk-vendors.js"></script><script src="/san-test-utils/static/js/client-entry.js"></script></body></html>